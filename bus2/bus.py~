#! -*- coding:utf-8 -*-

from random import randint,choice
import re

from django.shortcuts import render
from django.shortcuts import render_to_response
from django.http import HttpResponse
from django.utils import simplejson
from django.core.mail import send_mail

from bus.models import *
from bus.json import render_json, return_positiondata
from bus.usersystem import user_register, user_login, user_logout

MYERROR = {'status':'error'}

#建立新的车辆设备
def buildnewbus(request):
    if request.method == 'POST':
        if request.POST.get('bus_id'):
            newbus_id = request.POST.get('bus_id')
            nowposition = NowPosition(longitude = 0, latitude =0, time = 0)
            nowposition.save()
            newbus = Bus(bus_id = newbus_id,bus_nowposition = nowposition)
            newbus.save()
            return render_json({'status':'success'})
        else:
            return render_json(MYERROR)
    else:
        return render_json(MYERROR)

#即时获取车辆位置
def getbusposition(request,test):
    if request.method == 'GET':
        if request.GET.get('bus_id'):
            newbus_id = request.GET.get('bus_id')
        else:
            return render_json(MYERROR)
        if request.GET.get('latitude'):
            try:
                new_latitude = float(request.GET.get('latitude'))
            except:
                return render_json(MYERROR)
        else:
            return render_json(MYERROR)
        if request.GET.get('longitude'):
            try:
                new_longitude = float(request.GET.get('longitude'))
            except:
                return render_json(MYERROR)
        else:
            return render_json(MYERROR)
        if request.GET.get('time'):
            new_time = request.GET.get('time')
        else:
            return render_json(MYERROR)
        new_nowposition = NowPosition(latitude = new_latitude, longitude = new_longitude, time = new_time)
        new_nowposition.save()
        try:
            bus = Bus.objects.get(bus_id = newbus_id)
            position = Position(latitude = bus.bus_nowposition.latitude, longitude = bus.bus_nowposition.longitude, time = bus.bus_nowposition.time)
            position.save()
            bus.bus_position.add(position)
            bus.bus_nowposition.delete()
            bus.bus_nowposition = new_nowposition
            bus.save()
            return render_json({'status':'success'})
        except:
            return render_json(MYERROR)
    else:
        return render_json(MYERROR)
#改变汽车设备的名称
def editbusname(request):
    if request.method == 'POST':
        if request.POST.get('bus_id'):
            newbus_id = request.POST.get('bus_id')
        else:
            return render_json(MYERROR)
        if request.POST.get('bus_name'):
            newbus_name = request.POST.get('bus_name')
        else:
            return render_json(MYERROR)
        try:
            bus = Bus.objects.get(bus_id = newbus_id)
            bus.bus_name = newbus_name
            bus.save()
            return render_json({'status':'success'})
        except:
            return render_json(MYERROR)
    else:
        return render_json(MYERROR)
